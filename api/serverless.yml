service: zsmseven-tracker-api

frameworkVersion: '3'

provider:
  name: aws
  runtime: python3.10
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  logRetentionInDays: 7
  environment:
    POLYGON_API_KEY: ${env:POLYGON_API_KEY}
    DYNAMODB_TABLE: ticker-data-${self:provider.stage}
    PORTFOLIOS_TABLE: portfolios-${self:provider.stage}
    TICKER_DATA_TABLE: ticker-data-${self:provider.stage}
    ANALYSES_TABLE: portfolio-analyses-${self:provider.stage}
    SQS_QUEUE_URL: https://sqs.us-east-1.amazonaws.com/076311063214/portfolio-queue-dev
    XAI_API_URL: ${env:XAI_API_URL}
    XAI_API_KEY: ${env:XAI_API_KEY}
  iamRoleStatements:
    - Effect: Allow
      Action:
        - logs:CreateLogGroup
        - logs:CreateLogStream
        - logs:PutLogEvents
      Resource: "*"
    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:Query
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:Scan
      Resource: "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.DYNAMODB_TABLE}"
    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:Scan
      Resource: "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.PORTFOLIOS_TABLE}"
    - Effect: Allow
      Action:
        - sqs:SendMessage
        - sqs:ReceiveMessage
        - sqs:DeleteMessage
      Resource: "*"
    - Effect: Allow
      Action:
        - lambda:InvokeFunction
      Resource: "*"
    - Effect: Allow
      Action:
        - dynamodb:PutItem
        - dynamodb:Query
      Resource: "arn:aws:dynamodb:${self:provider.region}:*:table/${self:provider.environment.ANALYSES_TABLE}"

functions:
  processTickers:
    handler: process_tickers.lambda_handler
    events:
      - schedule:
          rate: cron(30 22 ? * MON-FRI *)
          enabled: true
  processTicker:
    handler: process_ticker.lambda_handler
    reservedConcurrency: 1
    events:
      - sqs:
          arn: arn:aws:sqs:us-east-1:076311063214:portfolio-queue-dev
          batchSize: 1
  analyzePortfolio:
    handler: analyze_portfolio.lambda_handler
    timeout: 300

resources:
  Resources:
    TickerDataTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_TABLE}
        AttributeDefinitions:
          - AttributeName: ticker
            AttributeType: S
          - AttributeName: timestamp
            AttributeType: S
        KeySchema:
          - AttributeName: ticker
            KeyType: HASH
          - AttributeName: timestamp
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
    PortfoliosTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.PORTFOLIOS_TABLE}
        AttributeDefinitions:
          - AttributeName: portfolio_name
            AttributeType: S
        KeySchema:
          - AttributeName: portfolio_name
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
    PortfolioAnalysesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.ANALYSES_TABLE}
        AttributeDefinitions:
          - AttributeName: portfolio
            AttributeType: S
          - AttributeName: timestamp
            AttributeType: S
        KeySchema:
          - AttributeName: portfolio
            KeyType: HASH
          - AttributeName: timestamp
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST

plugins:
  - serverless-python-requirements

# custom:
#   customDomain:
#     domainName: ${self:custom.domain.${self:provider.stage}}
#     basePath: ''
#     stage: ${self:provider.stage}
#     createRoute53Record: true

#   domain:
#     dev: devapi.zsmproperties.com
#     prod: api.zsmproperties.com